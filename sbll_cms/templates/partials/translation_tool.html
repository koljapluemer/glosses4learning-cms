<div id="translation-tool" class="card bg-base-200">
  <div class="card-body space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="card-title text-sm">AI Translation</h3>
    </div>
    {% if error %}
      <div class="alert alert-error py-2 flex items-center justify-between">
        <span>{{ error }}</span>
        <a class="btn btn-ghost btn-xs" href="{{ url_for('settings.settings') }}" target="_blank">Settings</a>
      </div>
    {% endif %}
      <form hx-post="{{ url_for('htmx.translation_tool', language=gloss.language, slug=gloss.slug) }}"
            hx-target="#translation-tool"
            hx-swap="outerHTML"
            class="grid md:grid-cols-[1fr_1fr_auto] gap-3 items-end">
        <label class="form-control">
          <div class="label"><span class="label-text text-xs uppercase">Target language</span></div>
          <select name="target_language" class="select select-bordered select-sm">
            {% for lang in languages %}
              {% if lang.iso_code != gloss.language %}
                <option value="{{ lang.iso_code }}" {% if lang.iso_code == target_language %}selected{% endif %}>{{ lang.symbol }} â€” {{ lang.display_name }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </label>
        <label class="form-control">
          <div class="label"><span class="label-text text-xs uppercase">Provider & Model</span></div>
          <select name="provider_model" class="select select-bordered select-sm">
            <option value="OpenAI|gpt-4o-mini" {% if provider_model == "OpenAI|gpt-4o-mini" %}selected{% endif %}>OpenAI | gpt-4o-mini</option>
            <option value="OpenAI|gpt-4.1" {% if provider_model == "OpenAI|gpt-4.1" %}selected{% endif %}>OpenAI | gpt-4.1</option>
          </select>
        </label>
        <button class="btn btn-primary btn-sm" type="submit">Generate</button>
        <div class="md:col-span-3">
          <label class="form-control">
            <div class="label"><span class="label-text text-xs uppercase">Context (optional)</span></div>
            <textarea name="context" class="textarea textarea-bordered textarea-sm" rows="2" placeholder="e.g., use polite form, noun not verb">{{ context or '' }}</textarea>
          </label>
        </div>
      </form>

    {% if message %}
      <div class="alert alert-success py-2">{{ message }}</div>
    {% endif %}

    {% if result %}
      <div class="p-3 bg-base-100 rounded border space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-base-content/70">{{ result.provider }} {{ result.model }}</p>
            <p class="font-semibold">Generated</p>
          </div>
        </div>
        {% if result.translations %}
          <div class="overflow-x-auto">
            <table class="table table-xs">
              <thead>
                <tr>
                  <th class="w-12"></th>
                  <th>Translation</th>
                </tr>
              </thead>
              <tbody>
                {% for t in result.translations %}
                  <tr>
                    <td>
                      <input type="checkbox" name="selected_translation" value="{{ t }}" form="translation-actions" class="checkbox checkbox-sm" checked>
                    </td>
                    <td>{{ t }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
        <div class="flex gap-2">
          <form id="translation-actions"
                hx-post="{{ url_for('htmx.translation_tool', language=gloss.language, slug=gloss.slug) }}"
                hx-target="#translation-tool"
                hx-swap="outerHTML">
            <input type="hidden" name="translations_json" value='{{ result.translations | tojson }}'>
            <input type="hidden" name="target_language" value="{{ target_language }}">
            <input type="hidden" name="provider_model" value="{{ provider_model }}">
            <input type="hidden" name="context" value="{{ context }}">
            <div class="flex gap-2">
              <button class="btn btn-sm" name="action" value="discard_all" type="submit">Discard all</button>
              <button class="btn btn-sm" name="action" value="accept_all" type="submit">Accept all</button>
              <button class="btn btn-primary btn-sm" name="action" value="accept_selection" type="submit">Accept selection</button>
            </div>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</div>

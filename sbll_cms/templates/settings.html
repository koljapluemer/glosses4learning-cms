{% extends "layout.html" %}
{% set title = "Settings" %}
{% block content %}
  <div class="mb-4 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">Settings</h1>
      <p class="text-sm text-base-content/70">API keys are stored locally in your browser's localStorage.</p>
    </div>
  </div>
  <form method="post" class="card bg-base-100 shadow-md" id="settings-form">
    <div class="card-body space-y-3">
      <label class="form-control">
        <div class="label"><span class="label-text font-semibold">OpenAI API Key</span></div>
        <input type="password" name="openai" id="openai-key" class="input input-bordered" value="{{ settings.api_keys.openai or '' }}" placeholder="sk-..." autocomplete="off" />
      </label>
      <label class="form-control">
        <div class="label"><span class="label-text font-semibold">DeepL API Key</span></div>
        <input type="password" name="deepl" id="deepl-key" class="input input-bordered" value="{{ settings.api_keys.deepl or '' }}" placeholder="deepl-key" autocomplete="off" />
      </label>
      <div class="card-actions justify-end">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </div>
  </form>
  <script>
    (function() {
      const STORAGE_KEY = 'sbll_cms_settings';

      // Load settings from localStorage on page load
      function loadFromLocalStorage() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            const settings = JSON.parse(stored);
            if (settings.api_keys) {
              if (settings.api_keys.openai) {
                document.getElementById('openai-key').value = settings.api_keys.openai;
              }
              if (settings.api_keys.deepl) {
                document.getElementById('deepl-key').value = settings.api_keys.deepl;
              }
            }
          }
        } catch (e) {
          console.error('Error loading settings from localStorage:', e);
        }
      }

      // Save settings to localStorage before form submission
      function saveToLocalStorage(e) {
        const openai = document.getElementById('openai-key').value.trim() || null;
        const deepl = document.getElementById('deepl-key').value.trim() || null;

        const settings = {
          api_keys: {
            openai: openai,
            deepl: deepl
          }
        };

        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        } catch (e) {
          console.error('Error saving settings to localStorage:', e);
        }
      }

      // Load settings when page loads
      loadFromLocalStorage();

      // Save to localStorage when form is submitted
      document.getElementById('settings-form').addEventListener('submit', saveToLocalStorage);
    })();
  </script>
{% endblock %}

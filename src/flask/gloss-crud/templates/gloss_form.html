{% extends "layout.html" %}
{% set is_edit = gloss and gloss.slug %}
{% set title = (gloss.content if is_edit else "New gloss") %}
{% block content %}
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <p class="text-light uppercase tracking-wide">{{ gloss.language }}</p>
      <h1 class="text-3xl font-semibold">{{ gloss.content if is_edit else "Create gloss" }}</h1>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{{ url_for('list_glosses') }}" class="btn btn-ghost gap-2">
        <i class="w-4 h-4" data-lucide="list"></i>
        <span>Back to list</span>
      </a>
      {% if is_edit %}
        <form method="post" action="{{ url_for('delete_gloss', language=gloss.language, slug=gloss.slug) }}" onsubmit="return confirm('Delete this gloss?');">
          <button class="btn btn-ghost gap-2" type="submit">
            <i class="w-4 h-4" data-lucide="trash-2"></i>
            <span>Delete</span>
          </button>
        </form>
      {% endif %}
      <button form="gloss-form" type="submit" class="btn btn-primary gap-2">
        <i class="w-4 h-4" data-lucide="save"></i>
        <span>{{ "Save" if is_edit else "Create" }}</span>
      </button>
    </div>
  </div>

  <form id="gloss-form" method="post" class="space-y-4">
    <div class="grid lg:grid-cols-[2fr_1fr] gap-4">
      <div class="space-y-4">
        <div class="card shadow">
          <div class="card-body space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
              <fieldset class="fieldset">
                <label class="label">Language (ISO 639-3)</label>
                {% if is_edit %}
                  <input type="text" class="input" value="{{ gloss.language }}" disabled>
                {% else %}
                  <select name="language" class="select" required>
                    {% for lang in languages %}
                      <option value="{{ lang.iso }}" {% if lang.iso == gloss.language %}selected{% endif %}>{{ lang.symbol or lang.iso | upper }} â€” {{ lang.name }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              </fieldset>
            </div>
            <fieldset class="fieldset">
              <label class="label">Content *</label>
              <textarea name="content" class="textarea" required placeholder="Surface form or definition">{{ gloss.content }}</textarea>
            </fieldset>
          </div>
        </div>

        <div class="card shadow">
          <div class="card-body space-y-3">
            <div class="flex items-center justify-between">
              <h2 class="card-title">Transcriptions</h2>
              <span class="text-light">One per line: key: value</span>
            </div>
            <textarea name="transcriptions" class="textarea min-h-24" placeholder="IPA: ...&#10;Other: ...">{% if gloss.transcriptions %}{% for k,v in gloss.transcriptions.items() %}{{ k }}: {{ v }}{% if not loop.last %}&#10;{% endif %}{% endfor %}{% endif %}</textarea>
          </div>
        </div>
      </div>

      <div class="card shadow">
        <div class="card-body space-y-3">
          <h2 class="card-title">Actions</h2>
          <button class="btn btn-primary w-full" type="submit" name="next" value="stay">
            <i class="w-4 h-4" data-lucide="save"></i>
            <span>{{ "Save changes" if is_edit else "Create gloss" }}</span>
          </button>
          {% if is_edit %}
            <button class="btn btn-ghost w-full" type="submit" name="next" value="list">
              <i class="w-4 h-4" data-lucide="list"></i>
              <span>Save &amp; return to list</span>
            </button>
          {% endif %}
          <a class="btn btn-ghost w-full" href="{{ url_for('list_glosses') }}">
            <i class="w-4 h-4" data-lucide="arrow-left"></i>
            <span>Cancel</span>
          </a>
        </div>
      </div>
    </div>
  </form>

  {% if is_edit %}
    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <i class="w-4 h-4" data-lucide="git-branch"></i>
        <h2 class="text-2xl font-semibold">Relationships</h2>
      </div>
      {% set order = ['translations','tags','notes','morphologically_related','parts','has_similar_meaning','sounds_similar','usage_examples','to_be_differentiated_from','collocations','typical_follow_up','children'] %}
      {% for field in order %}
        {% if not relation_fields or field in relation_fields %}
          <div id="skeleton-{{ field }}"
               class="card shadow"
               hx-get="{{ url_for('relation_card', language=gloss.language, slug=gloss.slug, field=field) }}"
               hx-trigger="load"
               hx-target="this"
               hx-swap="outerHTML">
            <div class="card-body">
              <div class="animate-pulse space-y-2">
                <div class="h-4 bg-base-300/70 rounded"></div>
                <div class="h-3 bg-base-300/60 rounded"></div>
                <div class="h-3 bg-base-300/50 rounded w-1/2"></div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
